/**
 * 共享工具函数 - 小程序兼容版本
 */

/**
 * 生成会话 ID
 */
function generateSessionId() {
  return 'session_' + Date.now() + '_' + Math.random().toString(36).substring(2, 11);
}

/**
 * 生成唯一 ID
 */
function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).substring(2);
}

/**
 * 格式化金额
 */
function formatAmount(amount, decimals) {
  decimals = decimals || 2;
  if (typeof amount !== 'number' || isNaN(amount)) {
    return '0.00';
  }
  return amount.toFixed(decimals);
}

/**
 * 格式化日期
 */
function formatDate(date) {
  if (typeof date === 'string') {
    date = new Date(date);
  }
  var year = date.getFullYear();
  var month = String(date.getMonth() + 1).padStart(2, '0');
  var day = String(date.getDate()).padStart(2, '0');
  return year + '-' + month + '-' + day;
}

/**
 * 格式化时间
 */
function formatTime(date) {
  if (typeof date === 'string') {
    date = new Date(date);
  }
  var hours = String(date.getHours()).padStart(2, '0');
  var minutes = String(date.getMinutes()).padStart(2, '0');
  return hours + ':' + minutes;
}

/**
 * 格式化日期时间
 */
function formatDateTime(date) {
  return formatDate(date) + ' ' + formatTime(date);
}

/**
 * 格式化相对时间
 */
function formatRelativeTime(date) {
  if (typeof date === 'string') {
    date = new Date(date);
  }
  var now = new Date();
  var diff = now.getTime() - date.getTime();
  var seconds = Math.floor(diff / 1000);
  var minutes = Math.floor(seconds / 60);
  var hours = Math.floor(minutes / 60);
  var days = Math.floor(hours / 24);

  if (days > 0) {
    if (days === 1) return '昨天';
    if (days === 2) return '前天';
    if (days < 7) return days + '天前';
    return formatDate(date);
  }
  if (hours > 0) return hours + '小时前';
  if (minutes > 0) return minutes + '分钟前';
  return '刚刚';
}

/**
 * 防抖函数
 */
function debounce(fn, delay) {
  delay = delay || 300;
  var timer = null;
  return function() {
    var context = this;
    var args = arguments;
    if (timer) clearTimeout(timer);
    timer = setTimeout(function() {
      fn.apply(context, args);
    }, delay);
  };
}

/**
 * 节流函数
 */
function throttle(fn, interval) {
  interval = interval || 300;
  var lastTime = 0;
  return function() {
    var now = Date.now();
    if (now - lastTime >= interval) {
      lastTime = now;
      fn.apply(this, arguments);
    }
  };
}

/**
 * 延迟执行
 */
function delay(ms) {
  return new Promise(function(resolve) {
    setTimeout(resolve, ms);
  });
}

// 导出
module.exports = {
  generateSessionId: generateSessionId,
  generateId: generateId,
  formatAmount: formatAmount,
  formatDate: formatDate,
  formatTime: formatTime,
  formatDateTime: formatDateTime,
  formatRelativeTime: formatRelativeTime,
  debounce: debounce,
  throttle: throttle,
  delay: delay
};

