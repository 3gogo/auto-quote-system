/**
 * 共享 API 服务 - 小程序兼容版本
 * 可以被小程序和 H5 同时使用
 */

// 配置
let apiBaseUrl = 'http://localhost:3001/api';
let httpRequest = null;

/**
 * 设置 API 基础 URL
 */
function setApiBaseUrl(url) {
  apiBaseUrl = url.replace(/\/$/, '');
}

/**
 * 获取 API 基础 URL
 */
function getApiBaseUrl() {
  return apiBaseUrl;
}

/**
 * 设置 HTTP 请求实现
 * @param {Function} fn - 请求函数，接收 options 返回 Promise
 */
function setHttpRequest(fn) {
  httpRequest = fn;
}

/**
 * 发起请求
 */
async function request(options) {
  if (!httpRequest) {
    throw new Error('请先调用 setHttpRequest 设置请求实现');
  }
  
  const response = await httpRequest({
    url: apiBaseUrl + options.url,
    method: options.method || 'GET',
    data: options.data,
    header: options.header
  });
  
  if (!response.success) {
    throw new Error(response.error?.message || '请求失败');
  }
  return response.data;
}

// ========== 语音处理 API ==========

/**
 * 处理语音并获取报价
 */
async function processVoice(data) {
  return request({
    url: '/voice/process',
    method: 'POST',
    data: data
  });
}

// ========== 对话 API ==========

/**
 * 发送文本消息
 */
async function sendMessage(data) {
  return request({
    url: '/conversation/chat',
    method: 'POST',
    data: data
  });
}

/**
 * 清除会话
 */
async function clearSession(sessionId) {
  return request({
    url: '/conversation/session/' + sessionId,
    method: 'DELETE'
  });
}

// ========== 交易 API ==========

/**
 * 确认交易
 */
async function confirmTransaction(quote, sessionId) {
  return request({
    url: '/transaction',
    method: 'POST',
    data: Object.assign({}, quote, { sessionId: sessionId })
  });
}

/**
 * 获取交易列表
 */
async function getTransactionList(params) {
  params = params || {};
  var queryParts = [];
  if (params.page) queryParts.push('page=' + params.page);
  if (params.pageSize) queryParts.push('pageSize=' + params.pageSize);
  if (params.startDate) queryParts.push('startDate=' + params.startDate);
  if (params.endDate) queryParts.push('endDate=' + params.endDate);
  if (params.partnerId) queryParts.push('partnerId=' + params.partnerId);
  
  var query = queryParts.join('&');
  return request({
    url: '/transaction' + (query ? '?' + query : ''),
    method: 'GET'
  });
}

/**
 * 获取交易详情
 */
async function getTransactionDetail(id) {
  return request({
    url: '/transaction/' + id,
    method: 'GET'
  });
}

/**
 * 获取今日统计
 */
async function getTodayStats() {
  var today = new Date().toISOString().split('T')[0];
  return request({
    url: '/transaction/stats/summary?startDate=' + today + '&endDate=' + today,
    method: 'GET'
  });
}

/**
 * 获取热门商品
 */
async function getTopProducts() {
  return request({
    url: '/transaction/stats/top-products',
    method: 'GET'
  });
}

// 导出
module.exports = {
  setApiBaseUrl: setApiBaseUrl,
  getApiBaseUrl: getApiBaseUrl,
  setHttpRequest: setHttpRequest,
  processVoice: processVoice,
  sendMessage: sendMessage,
  clearSession: clearSession,
  confirmTransaction: confirmTransaction,
  getTransactionList: getTransactionList,
  getTransactionDetail: getTransactionDetail,
  getTodayStats: getTodayStats,
  getTopProducts: getTopProducts
};

