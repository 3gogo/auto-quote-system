# 小店 AI 报价助手 - 技术架构设计

> 版本：v1.0  \n适用场景：夫妻店 / 小杂货铺 / 小型便利店  \n目标：无数据自动记忆的 AI 报价系统

---

## 1. 设计目标

- **零初始化启动**：无需预先录入商品和顾客信息，系统通过“用一次、记一点”自动积累记忆
- **语音优先交互**：男店主通过自然语言即可完成询价、报价、确认等操作
- **智能定价引擎**：基于历史成交数据和规则体系，给出符合人情习惯的推荐价格
- **渐进式结构化**：从原始交易日志中自动挖掘候选记忆，女店主可轻量复盘确认
- **低门槛维护**：后台操作控制在每天 3–10 分钟，适合碎片时间处理

---

## 2. 整体架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                           用户层                                  │
├─────────────────────────────────────────────────────────────────┤
│  前端交互层                                                       │
│  ├─ 语音交互模块 (ASR + TTS)                                       │
│  ├─ NLU 意图识别与实体抽取                                         │
│  └─ 简单 UI 界面 (可选)                                            │
├─────────────────────────────────────────────────────────────────┤
│  业务逻辑层                                                       │
│  ├─ 定价引擎 (Pricing Engine)                                      │
│  │   ├─ 规则匹配 (Rule Matcher)                                    │
│  │   ├─ 历史学习 (Historical Learning)                             │
│  │   └─ 抹零建议 (Rounding Suggestion)                             │
│  ├─ 记忆管理 (Memory Manager)                                      │
│  │   ├─ 原始交易日志 (Raw Transaction Logs)                        │
│  │   ├─ 候选记忆层 (Candidate Memory)                              │
│  │   │   ├─ 商品候选 (Product Candidates)                          │
│  │   │   └─ 顾客候选 (Partner Candidates)                          │
│  │   └─ 结构化记忆层 (Structured Memory)                           │
│  │       ├─ 商品表 (Products)                                      │
│  │       ├─ 顾客/供货商表 (Partners)                               │
│  │       ├─ 定价规则表 (Pricing Rules)                             │
│  │       └─ 交易记录表 (Transactions)                              │
│  ├─ 对话管理 (Dialogue Manager)                                    │
│  └─ 后台管理 (Admin Backend)                                       │
├─────────────────────────────────────────────────────────────────┤
│  数据访问层                                                       │
│  ├─ ORM / 数据库访问 (MySQL/PostgreSQL)                            │
│  └─ 缓存层 (Redis)                                                 │
├─────────────────────────────────────────────────────────────────┤
│  基础设施层                                                       │
│  ├─ 应用服务 (Node.js/Python)                                      │
│  ├─ ASR/TTS 服务 (本地/云端)                                       │
│  ├─ 向量检索 (可选，用于别名聚类)                                   │
│  └─ 任务调度 (Celery/Background Jobs)                              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 核心模块设计

### 3.1 前端交互层

#### 3.1.1 语音交互模块

- **ASR (语音识别)**
  - 本地优先：使用 Whisper.cpp / Vosk 等轻量本地模型，降低延迟与网络依赖
  - 云端备选：科大讯飞/百度云 ASR（热词增强：商品名、品牌名）
  - 热词配置：支持自定义商品别名、顾客称呼提升识别准确率

- **TTS (语音合成)**
  - 本地：使用 PaddleSpeech / Edge-TTS，输出清晰自然的中文语音
  - 可配置：男女声、语速、音量

#### 3.1.2 NLU 意图识别与实体抽取

- **意图识别**
  - 零售报价 (retail_quote)
  - 进货核价/售价建议 (purchase_price_check)
  - 单品价格查询 (single_item_query)
  - 纠错/改价 (price_correction)
  - 简单确认/否定 (confirm/deny)

- **实体抽取**
  - 顾客/供货商称呼：张三、老李、隔壁小卖部
  - 商品名称：可乐、蓝月亮洗衣液、心相印纸巾
  - 数量与单位：2瓶、3包、1箱
  - 价格表达：3块、5块5

- **实现建议**
  - 轻量模型：使用 MiniLM / ERNIE-Tiny 等小模型部署在本地
  - 规则增强：结合正则表达式与词典匹配，提升实体召回
  - 置信度阈值：低于阈值时通过简短追问确认

#### 3.1.3 简单 UI 界面（可选）

- 触摸屏展示报价结果与确认按钮
- 后台管理页面（今日复盘、规则配置）

---

### 3.2 业务逻辑层

#### 3.2.1 定价引擎

**核心流程**：

1. 接收商品与顾客信息
2. 查找顾客类型与商品成本
3. 按优先级匹配规则：
   - 专用规则（顾客+商品）
   - 顾客类型规则
   - 商品类别规则
   - 全店默认规则
4. 计算推荐价与抹零建议
5. 输出最终报价

**规则优先级**：

| 优先级 | 规则类型 | 示例 |
|--------|----------|------|
| 1 | 顾客+商品专用 | 张三买可乐统一3元/瓶 |
| 2 | 顾客类型 | 熟客：成本×1.25，普通：成本×1.4 |
| 3 | 商品类别 | 饮料：成本×1.2，纸品：成本×1.25 |
| 4 | 全店默认 | 成本×1.3 或历史平均毛利 |

**历史学习机制**：

- 当前无规则时，基于历史成交价给出“经验价”
- 记录每次成交价，更新价格分布
- 高频稳定的价格自动推荐生成专用规则

#### 3.2.2 记忆管理

**三层记忆结构**：

1. **原始交易日志层**
   - 记录每笔交易完整信息：时间、原始语音文本、解析结果、成交价
   - 存储在数据库 `transactions` 表

2. **候选记忆层**
   - 从日志中自动提取高频商品词、顾客称呼
   - 使用文本相似度聚类合并别名（如“可乐”“可口可乐”）
   - 定期生成候选列表供女店主确认

3. **结构化记忆层**
   - 女店主确认后，提升为正式记录
   - 商品：统一名称、条码、类别、成本
   - 顾客：类型标签、备注
   - 规则：专用规则、类别规则

#### 3.2.3 对话管理

- 支持多轮交互：记住本轮上下文（顾客、商品）
- 低置信度时主动追问，提升识别准确率
- 自然过渡到报价或确认流程

#### 3.2.4 后台管理

- **今日复盘页**
  - 高频商品候选（带别名聚类）
  - 今日常见顾客与消费情况
  - 偏差较大的交易记录

- **操作功能**
  - 商品合并与命名
  - 顾客类型设置
  - 一键生成规则

---

### 3.3 数据访问层

#### 3.3.1 数据库设计（MySQL/PostgreSQL）

**核心表结构**：

1. **products**（商品）
   - id, name, aliases, barcode, category, unit, base_cost, is_active

2. **partners**（顾客/供货商）
   - id, name, type, level, note, created_at

3. **pricing_rules**（定价规则）
   - id, scope_type, scope_value, formula, rounding, priority, enabled

4. **transactions**（交易记录）
   - id, partner_id, timestamp, items_json, total_price, total_cost, raw_text, intent

5. **candidate_products**（商品候选）
   - name, frequency, price_distribution, aliases_cluster

6. **candidate_partners**（顾客候选）
   - name, frequency, total_amount, visit_count

#### 3.3.2 缓存层（Redis）

- 缓存近期活跃商品与顾客信息，提升响应速度
- 缓存规则匹配结果，减少重复计算

---

### 3.4 基础设施层

#### 3.4.1 应用服务

- **技术栈建议**
  - 后端：Node.js (Express) 或 Python (FastAPI/Flask)
  - 数据库：MySQL 8.0 或 PostgreSQL 14+
  - 缓存：Redis 6+

- **部署**
  - 本地部署优先：树莓派/小型工控机
  - 可选云端同步：定期备份到云端

#### 3.4.2 ASR/TTS 服务

- 本地服务：Whisper.cpp (ASR), PaddleSpeech (TTS)
- 云端备选：科大讯飞、百度云（需网络）

#### 3.4.3 向量检索（可选）

- 使用 Sentence-BERT + Faiss/Pinecone
- 用于商品别名聚类与顾客称呼合并

#### 3.4.4 任务调度

- 使用 Celery (Python) 或 Bull (Node.js)
- 定期执行：
  - 候选记忆聚合
  - 价格分布更新
  - 规则推荐生成

---

## 4. 关键流程时序

### 4.1 零售报价流程

```
男店主 → 唤醒 → ASR → NLU → 匹配顾客 → 匹配商品 → 定价引擎 → TTS播报 → 男店主确认 → 记录交易
```

### 4.2 无数据启动流程

```
首次遇到新顾客/商品 → 简单询问 → 记录为候选 → 使用用户输入价 → 后续自动学习
```

### 4.3 打烊后复盘流程

```
女店主打开后台 → 查看高频候选 → 合并命名 → 设置类型 → 生成规则 → 更新结构化记忆
```

---

## 5. 非功能设计

### 5.1 性能

- 语音识别 + 报价响应：1–3 秒
- 本地缓存热点数据，减少数据库查询

### 5.2 可用性

- 网络异常时本地缓存可用
- ASR 降级策略：本地模型优先，云端备选

### 5.3 数据安全

- 本地存储优先，敏感数据不上传
- 支持定期备份与导出
- 用户权限控制（店主/管理员）

### 5.4 可维护性

- 模块化设计，接口清晰
- 日志记录完整，便于排查
- 配置热更新（规则、热词）

---

## 6. 技术选型建议

| 模块 | 推荐技术 | 备选 |
|------|----------|------|
| 后端 | Node.js (Express) / Python (FastAPI) | Go (Gin) |
| 数据库 | MySQL 8.0 | PostgreSQL |
| 缓存 | Redis | Memory Cache |
| ASR | Whisper.cpp / Vosk | 科大讯飞 |
| TTS | PaddleSpeech / Edge-TTS | 百度云 |
| NLU | ERNIE-Tiny / MiniLM | BERT |
| 向量检索 | Sentence-BERT + Faiss | Pinecone |
| 任务调度 | Celery / Bull | Agenda |

---

## 7. 实施路线图

### 阶段 1：MVP 原型（2–3 周）
- 实现语音唤醒 + ASR/TTS
- 基础 NLU 与意图识别
- 简单规则 + 交易记录
- 本地数据库

### 阶段 2：自动记忆（2 周）
- 候选记忆层实现
- 商品/顾客自动发现
- 后台复盘界面

### 阶段 3：智能优化（2 周）
- 向量聚类优化别名合并
- 自动规则推荐
- 毛利分析报表

---

## 8. 风险与应对

| 风险 | 应对策略 |
|------|----------|
| 语音识别准确率低 | 本地模型 + 热词增强 + 简单追问 |
| 规则配置复杂 | 提供默认规则模板，支持一键生成 |
| 数据量大导致性能下降 | 定期归档旧数据，只缓存近期活跃数据 |
| 网络不稳定 | 本地优先，离线可用 |

---

## 9. 总结

本架构围绕“无数据自动记忆”核心理念，通过三层记忆结构实现从原始日志到结构化知识的渐进式演进。语音优先交互降低使用门槛，智能定价引擎结合规则与历史学习，确保报价符合人情习惯。整体设计轻量、可扩展，适合夫妻店场景快速落地。